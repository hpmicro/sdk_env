HPM MCL V2 中间件
================

概述
----

HPM MCL V2是一个用于电机控制的中间件库，提供了完整的电机控制解决方案。该中间件支持多种电机控制算法和功能，包括FOC（磁场定向控制）、SMC（滑模控制）、硬件FOC加速、硬件混合环路加速等。

主要特性
--------

- 支持多种电机控制算法
  - 磁场定向控制(FOC)
  - 滑模控制(SMC)
  - 无传感器控制
  - 硬件FOC控制
    - 使用VSC、CLC和QEO模块的完整硬件电流环
    - 硬件加速Clarke/Park变换和电流控制
    - 实时硬件PWM生成
  - 硬件混合环路FOC控制
    - VSC（矢量信号控制器）硬件加速Clarke/Park变换
    - CLC（电流环控制器）硬件加速电流控制
    - QEO（正交编码器输出）硬件加速逆变换
    - 通过回调函数进行软硬件数据交换
    - 动态使能/禁用各个硬件模块
  - 步进电机FOC控制
    - 支持梯形曲线路径规划
    - 支持加速度、减速度、速度和时间参数配置
- 支持多种编码器类型
- 支持死区补偿
- 支持DQ轴解耦
- 支持角度预测
- 提供完整的物理参数配置接口
- 支持多种调试功能
- 支持离线参数检测
- 支持多种滤波器
  - IIR滤波器
  - PLL I型滤波器
  - PLL II型滤波器

目录结构
--------

- core/ - 核心控制算法实现
  - control/ - 控制算法实现
    - hpm_mcl_control.h/c - 控制算法核心实现
    - hpm_mcl_filter.h/c - 滤波器实现
    - hpm_mcl_path_plan.h/c - 步进电机路径规划实现
  - loop/ - 控制循环实现
  - sensor/ - 传感器相关实现
  - drivers/ - 驱动层实现
  - detect/ - 检测功能实现
- drivers/ - 驱动层实现
  - hpm_mcl_hw_loop.h/c - 硬件混合环路实现
- encoder/ - 编码器相关实现
- hpm_mcl_common.h - 通用定义和宏
- hpm_mcl_physical.h - 物理参数定义
- hpm_mcl_math.h - 数学运算函数
- hpm_mcl_debug.h - 调试功能
- hpm_mcl_cfg.h - 配置选项

控制功能
--------

- 电流控制
  - D轴电流PID控制
  - Q轴电流PID控制
  - 硬件CLC加速电流环控制
- 速度控制
  - 速度PID控制
- 位置控制
  - 位置PID控制
- 电机角度对中
  - 支持多种对中算法
    - 基础单阶段对中：简单快速的对中算法，参数可配置
    - 三阶段对中：增强的鲁棒对中算法，适用于困难位置（如90度机械角度）
      - 第一阶段：大电流粗对中，带q轴扰动
      - 第二阶段：中等电流精对中
      - 第三阶段：小电流稳定化
  - 硬件/软件FOC兼容性
    - 用户根据模式选择合适的电流值
    - 中间件内部无模式区分
- 硬件FOC控制
  - 完整的基于硬件的电流环实现
  - VSC硬件加速坐标变换
  - CLC硬件加速电流调节
  - QEO硬件加速PWM生成
  - 集成硬件控制流水线
- 硬件混合环路控制
  - VSC硬件加速
    - Clarke变换（abc到αβ）
    - Park变换（αβ到dq）
    - 硬件加速坐标变换
  - CLC硬件加速
    - 基于硬件的电流环控制
    - D轴和Q轴电流调节
    - 硬件实时PID计算
  - QEO硬件加速
    - 逆Park变换（dq到αβ）
    - 逆Clarke变换（αβ到abc）
    - 硬件生成PWM占空比
  - 通过回调函数进行软硬件数据交换
  - 动态控制各个硬件模块
- 步进电机控制
  - 梯形曲线路径规划
  - 支持加速度、减速度、速度和时间参数配置
- 滤波器
  - IIR滤波器（DF1结构）
  - PLL I型滤波器
  - PLL II型滤波器
- 离线参数检测
  - 电阻检测
  - 电感检测
  - 磁链检测

配置选项
--------

- MCL_EN_THETA_FORECAST - 启用角度预测
- MCL_EN_DQ_AXIS_DECOUPLING_FUNCTION - 启用DQ轴解耦
- MCL_EN_DEAD_AREA_COMPENSATION - 启用死区补偿
- MCL_EN_SENSORLESS_SMC - 启用无传感器SMC控制
- HW_CURRENT_FOC_ENABLE - 启用硬件FOC模式（完整硬件电流环）
- MCL_USER_DEFINED_DEBUG_FIFO - 调试FIFO大小

使用说明
--------

1. 配置物理参数
   - 电机参数（电阻、电感、极对数等）
   - 板级参数（采样电阻、ADC参考电压等）
   - 时间参数（PWM周期、控制周期等）

2. 选择控制算法
   - 根据应用需求选择合适的控制算法
   - 配置相应的参数
   - 选择适当的滤波器

3. 电机角度对中配置
   - 根据应用需求选择对中算法：
     - 基础算法：适用于简单快速的对中
     - 三阶段算法：适用于鲁棒对中，特别是电机可能从困难位置启动时
   - 配置算法特定参数：
     - 基础算法：设置d_current、q_current和delay_ms
     - 三阶段算法：配置每个阶段的电流和时间参数
   - 根据硬件/软件FOC模式选择合适的电流值：
     - 硬件模式：通常使用较大的电流值（如d轴6-8A）
     - 软件模式：通常使用较小的电流值（如d轴2-4A）
   - 使用示例：
     - motor_angle_align() - 使用三阶段算法和模式特定参数
     - 可通过选择不同算法和参数实现自定义实现

4. 硬件FOC配置
   - 启用HW_CURRENT_FOC_ENABLE宏以使用完整硬件电流环
   - 配置VSC、CLC和QEO硬件模块
   - 设置环路模式为mcl_mode_hardware_foc
   - 初始化硬件组件（VSC、CLC、QEO）
   - 配置硬件数据流的触发矩阵

5. 硬件混合环路配置
   - 设置环路模式为mcl_mode_hybrid_foc
   - 配置VSC、CLC和QEO硬件模块
   - 设置软硬件数据交换的转换回调函数
   - 使用hpm_mcl_hw_loop_init()初始化硬件环路组件
   - 使用以下函数启用特定的硬件加速模块：
     - hpm_mcl_enable_vsc_hardware_loop() 启用VSC加速
     - hpm_mcl_enable_clc_hardware_loop() 启用CLC加速
     - hpm_mcl_enable_qeo_hardware_loop() 启用QEO加速
   - 每个模块可以在运行时独立启用/禁用

6. 步进电机控制
   - 配置梯形曲线路径规划参数
   - 设置加速度、减速度和速度
   - 配置运行时间
   - 如需闭环控制，启用闭环控制功能
   - 配置闭环模式下的位置和速度控制参数

7. 调试功能
   - 使用提供的调试接口进行系统调试
   - 可以通过FIFO记录关键数据
   - 使用离线参数检测功能

注意事项
--------

- 使用前请确保正确配置所有物理参数
- 调试功能可能会影响实时性能，建议在开发阶段使用
- 不同控制算法可能需要不同的参数配置，请参考具体算法的文档
- 硬件FOC模式需要兼容的HPM MCU，具备VSC、CLC和QEO模块，提供完整的硬件电流环
- 硬件混合环路需要兼容的HPM MCU，具备VSC、CLC和QEO模块，用于部分硬件加速
- 硬件混合环路模块通过函数调用启用，而非编译时宏
- 在混合模式下必须正确实现转换回调函数以进行硬件-软件数据交换
- 步进电机路径规划时注意加速度和减速度的设置，避免机械冲击
- 滤波器参数需要根据实际应用场景进行调整

API兼容性
---------

有关不同版本之间API兼容性的信息，请参考：

- `API兼容性指南（中文） <API_COMPATIBILITY_GUIDE_zh.rst>`_

该指南提供了以下详细信息：

- v1.9.0和v1.10.0之间的API变化
- 向后兼容性解决方案
- 迁移建议
- 新旧API的使用示例
